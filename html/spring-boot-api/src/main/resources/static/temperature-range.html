<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highcharts Lazy Loading Example</title>
    <!-- 修改 Highcharts 引入 -->
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/data.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <style>
        #container {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>

<div>aa</div>
<div id="container"></div>
<script>
// 添加在 Highcharts.stockChart 之前
function loadData(chart, from, to) {
    const mainSeries = [chart.series[0], chart.series[1]];
    
    // 構建 URL，只有在參數存在時才添加
    const buildUrl = (seriesName) => {
        let url = `/api/temperature/${seriesName}/json`;
        const params = [];
        if (from !== undefined) params.push(`from=${from}`);
        if (to !== undefined) params.push(`to=${to}`);
        return params.length ? `${url}?${params.join('&')}` : url;
    };

    Promise.all(mainSeries.map(series => {
        const url = buildUrl(series.name);
        console.log(`Fetching data from: ${url}`);
        return fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Data for ${series.name}:`, data);
                series.setData(data);
            })
            .catch(error => {
                console.error(`Error loading data for ${series.name}:`, error);
            })
    }));
}

Highcharts.stockChart('container', {
    chart: {
        type: 'arearange',
        zooming: {
            type: 'x'
        },
        events: {
            load: function() {
                const chart = this;
                // 初始加載數據
                loadData(chart);
            }
        }
    },
    plotOptions: {
        arearange: {
            grouping: false,
            dataGrouping: {
                enabled: false
            }
        }
    },
    scrollbar: {
        enabled: true,
        liveRedraw: false
    },
    navigator: {
        enabled: true,
        height: 50,
        adaptToUpdatedData: false,
        series: {
            type: 'areaspline',
            lineWidth: 1
        },
        marker: {
            enabled: false
        }
    },
    
    xAxis: {
        type: 'datetime',
        minRange: 3600 * 1000,
        accessibility: {
            rangeDescription: 'Range: Jan 1st 2023 to Jan 1st 2024.'
        },
        events: {
            afterSetExtremes: function(e) {
                console.log("xAxis.afterSetExtremes", e.min, e.max);
                const chart = this.chart;
                loadData(chart, e.min, e.max);
            }
        }
    },
    yAxis: {
        title: {
            text: null
        }
    },
    tooltip: {
        crosshairs: true,
        shared: true,
        valueSuffix: '°C',
        xDateFormat: '%A, %b %e'
    },
    legend: {
        enabled: true,
        align: 'right',
        verticalAlign: 'top',
        layout: 'vertical'
    },
    series: [{
        name: 'Helsinki',
        showInNavigator: true,
        type: 'arearange'
    }, {
        name: 'Turku',
        showInNavigator: true,
        type: 'arearange'
    }]
});
</script>
</body>
</html>
